<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradición Norteña - Dashboard</title>

    <link rel="stylesheet" th:href="@{/css/dashboardStyle.css}" href="/css/DashboardStyle.css">
    <link rel="stylesheet" th:href="@{/css/mesasStyle.css}" href="/css/mesasStyle.css">
    <link rel="stylesheet" th:href="@{/css/platosStyle.css}" href="/css/platosStyle.css">
</head>
<body>
<div class="app-container" id="appSection">
    <div class="header">
        <h1>TRADICIÓN NORTEÑA</h1>
        <div class="user-info">
            <span id="userWelcome">Bienvenido, <span th:text="${staff_name}">Usuario</span></span>
            <form th:action="@{/logout}" method="post" style="display:inline;">
                <button id="logoutBtn" type="submit">Cerrar Sesión</button>
            </form>
        </div>
    </div>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs" id="navTabs">
        <div class="nav-tab" data-tab="personal" sec:authorize="hasAnyRole('ROLE_ADMINISTRADOR','ROLE_JEFE')">Personal
        </div>
        <div class="nav-tab" data-tab="mesas" sec:authorize="hasAnyRole('ROLE_ADMINISTRADOR','ROLE_JEFE','ROLE_MOZO')">
            Mesas
        </div>
        <div class="nav-tab" data-tab="platos"
             sec:authorize="hasAnyRole('ROLE_ADMINISTRADOR','ROLE_JEFE','ROLE_MOZO', 'ROLE_COCINERO')">Platos
        </div>
    </div>

    <div id="dynamicTabContent"></div>
</div>

<script>
    const navTabs = document.getElementById('navTabs');
    const dynamicTabContent = document.getElementById('dynamicTabContent');
    const navTabElements = document.querySelectorAll('.nav-tab');

    function removeOldScript() {
        const oldScript = document.getElementById('dynamic-tab-script');
        if (oldScript) {
            oldScript.remove();
        }
    }

    function cleanupWebSockets() {
        if (typeof disconnectTableWebSocket === 'function') {
            disconnectTableWebSocket();
        }
        if (typeof disconnectPlateStatusWebSocket === 'function') {
            disconnectPlateStatusWebSocket();
        }
        if (typeof cleanupMesas === 'function') {
            cleanupMesas();
        }
        if (typeof cleanupPlatos === 'function') {
            cleanupPlatos();
        }
    }

    navTabs && navTabs.addEventListener('click', function (e) {
        const tab = e.target.closest('.nav-tab');
        if (!tab) return;
        const tabName = tab.getAttribute('data-tab');
        navTabElements.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        cleanupWebSockets();

        if (tabName === 'personal') {
            removeOldScript();
            fetch('/dashboard/personal_fragment')
                .then(res => res.text())
                .then(html => {
                    dynamicTabContent.innerHTML = html;
                    const script = document.createElement('script');
                    script.id = 'dynamic-tab-script';
                    script.src = '/js/personal.js';
                    script.onload = function () {
                        if (typeof initPersonalTabEvents === 'function') {
                            initPersonalTabEvents();
                        }
                    };
                    document.body.appendChild(script);
                });

        } else if (tabName === 'platos') {
            removeOldScript();
            fetch('/dashboard/platos_fragment')
                .then(res => res.text())
                .then(html => {
                    dynamicTabContent.innerHTML = html;
                    const script = document.createElement('script');
                    script.id = 'dynamic-tab-script';
                    script.src = '/js/platos.js';
                    script.onload = function() {
                        if (typeof initializePlatos === 'function') {
                            initializePlatos();
                        }
                        if (typeof connectPlateStatusWebSocket === 'function') {
                            connectPlateStatusWebSocket();
                        }
                    };
                    document.body.appendChild(script);
                });

        } else if (tabName === 'mesas') {
            removeOldScript();
            fetch('/dashboard/mesas_fragment')
                .then(res => res.text())
                .then(html => {
                    dynamicTabContent.innerHTML = html;
                    const script = document.createElement('script');
                    script.id = 'dynamic-tab-script';
                    script.src = '/js/mesas.js';
                    script.onload = function () {
                        if (typeof initializeMesas === 'function') {
                            initializeMesas();
                        }
                        if (typeof connectTableWebSocket === 'function') {
                            connectTableWebSocket();
                        }
                    };
                    document.body.appendChild(script);
                });
        }
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</body>
</html>
